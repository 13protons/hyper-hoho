<html>
  <head>
    
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.0/mapbox-gl.css' rel='stylesheet' />
  </head>
  <body>
    <h1>HoHo Fo Sho</h1>
    <p id="status"></p>
    <div id='map' style='width: 400px; height: 300px;'></div>
    <script src="/dot.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.0/mapbox-gl.js'></script>
    <script>
      var vehicles = {};

      fetch('/api/status')
          .then(function (response) {
            return response.json();
          })
          .then(function (myJson) {
            var statusEl = document.getElementById('status');
            if (myJson.running) {
              statusEl.textContent = 'Busses are currently in service!';
            } else {
              statusEl.textContent = 'No busses currently running :\'(';
            }
            console.log(JSON.stringify(myJson));
          });

      mapboxgl.accessToken = 'pk.eyJ1IjoiMTNwcm90b25zIiwiYSI6ImViN2ZiYTgxN2Y2MDRiZDY0ZDM5MGVhODM4M2Y0MDU2In0._FjwlF00n_W_k2GBaUnCHQ';

      var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v9',
        center: [-83.045833, 42.331389],
        zoom: 10
      });
    
      pulsingDot = PulsingDot(100, map);

      function asPoints(objs) {
        return {
          "type": "FeatureCollection",
          "features": Object.values(objs).map(function(item){
            return {
              "type": "Feature",
              "geometry": {
                "type": "Point",
                "coordinates": [item.longitude, item.latitude]
              },
              "properties": {
                "title": item.name,
              }
            }
          })
        }
      }

      map.on('load', function () {
        map.addImage('pulsing-dot', pulsingDot, { pixelRatio: 2 });
        
        map.addSource('point', {
          "type": "geojson",
          "data": asPoints({123: {
            longitude: 0,
            latitude: 0
          }})
        });
        
        map.addLayer({
          "id": "points",
          "type": "symbol",
          "source": "point",
          "layout": {
            "icon-image": "pulsing-dot"
          }
        });

        var socket = io.connect('/');
        // check url for device serials
        socket.on('vehicleUpdate', function (data) {
          vehicles[data.id] = data;
          
          requestAnimationFrame(function(){
            map.getSource('point').setData(asPoints(vehicles));
          });
          
          console.log('got update', data);
        });
    });
      
    </script>
  </body>
</html>